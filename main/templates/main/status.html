{% extends 'main/base.html' %}

{% block page_title%}イラスト詳細 - にじさーち{% endblock %}

{% block content %}
<div class="container">
  <h2 class="h5 mt-5">イラスト詳細</h2>
  <hr>
  {% if not registered %}
    <p>現在詳細情報を取得中です。このページは3秒後に自動的に更新されます。</p>
  {% else %}
  <div id="app" class="container">
    <ul class="list-inline">
      <li class="list-inline-item"><a class="badge bg-primary rounded-pill text-decoration-none" href="{% url 'author' screen_name %}">@{{ screen_name }}</a></li>
      <li class="list-inline-item"><span class="badge bg-danger rounded-pill" v-if="!collection">未収載</span></li>
    </ul>
    <ul class="list-inline">
      {% for hashtag in hashtags %}
      <li class="list-inline-item">
          <a href="/search/?hashtags={{ hashtag }}" class="badge bg-info rounded-pill text-decoration-none">#{{ hashtag }}</a>
      </li>
      {% endfor %}
    </ul>
    <ul class="list-inline mt-3 v-cloak">
      <li class="list-inline-item">
        <a v-bind:href="'/search/?i2vtags='+encodeURIComponent(rating)" class="badge bg-secondary rounded-pill text-decoration-none">[[ rating ]]</a>
      </li>
      <li class="list-inline-item" v-for="tag in i2vtags">
        <a v-bind:href="'/search/?i2vtags='+encodeURIComponent(tag)" class="badge bg-secondary rounded-pill text-decoration-none">[[ tag ]]</a>
      </li>
    </ul>
    <ul class="list-inline mt-3 v-cloak">
      <li class="list-inline-item" v-for="character in characters">
          <a v-bind:href="'/search/?character='+encodeURIComponent(character.name_en)" class="badge bg-success rounded-pill text-decoration-none" :class="{ 'bg-success': confirmed, 'bg-dark': !confirmed }">
          <span v-if='character.name_ja == ""'>[[ character.name_en ]]</span>
          <span v-else>[[ character.name_ja ]]</span>
        </a>
      </li>
    </ul>
    <div class="row justify-content-center">
      <div class="col-1 my-auto"><button class="btn btn-outline-secondary" v-if="image_number > 0" v-on:click="updateImage(image_number-1)"><i class="bi bi-arrow-left"></i></button></div>
      <div class="col-8 col-lg-4"><img class="img-fluid" v-bind:src="media_url"></div>
      <div class="col-1 my-auto"><button class="btn btn-outline-secondary" v-if="image_number < image_data.length-1" v-on:click="updateImage(image_number+1)"><i class="bi bi-arrow-right"></i></button></div>
    </div>
  {% endif %}
  <hr>
  {% if registered %}
  <h2 class="h5 mt-4">キャラクター名の登録</h2>
  <div v-if="similar_characters.length > 0">
    <p class="h6 mt-4">候補をクリックしてください</p>
    <ul class="list-inline mt-3">
      <li class="list-inline-item" v-for="name in similar_characters">
        <button class="btn btn-outline-secondary btn-sm" v-on:click="registerName(name)">[[ name ]]</button>
      </li>
      <li class="list-inline-item"><button class="btn btn-outline-secondary btn-sm" v-on:click="registerName('original')">original</button>
      </li>
    </ul>
    <p class="h6 mt-4">正しい名前が候補にない場合はキャラクター名を英語で入力してください</p>
  </div>
  <div v-else>
    <p class="h6 mt-4">キャラクター名を英語で入力してください</p>
   </div>
  <div class="row gy-2 gx-3 align-items-center">
    <div class="col-auto">
      <input type="text" class="form-control" v-bind="character_name" ref="input" list="candidates" autocomplete="off" @keyup="suggest_character">
    </div>
    <div class="col-auto">
      <button v-on:click="submitInfo" class="btn btn-primary">登録</button>
    </div>
  </div>
  <datalist id="candidates">
    <option v-for="name in name_candidates" :value="name">
  </datalist>
  <h2 class="h5 mt-5">キャラクター情報の削除</h2>
  <p class="h6 mt-4">削除するキャラクター名を選んでください</p>
  <ul class="list-inline mt-3 mb-5">
    <li class="list-inline-item" v-for="character in characters">
      <button class="btn btn-secondary btn-sm" v-on:click="deleteName(character.name_en)">
        <span v-if='character.name_ja == ""'>[[ character.name_en ]]</span>
        <span v-else>[[ character.name_ja ]]</span>
      </button>
    </li>
  </ul>
  <h2 class="h5 mt-5">登録情報の修正</h2>
  <form @submit="formSubmit">
    {% csrf_token %}
    <div class="form-group">
      <div class="form-check form-check-inline" v-if="collection">
        <input class="form-check-input" type="radio" v-model="report_type" id="not_illust" value="not_illust">
        <label class="form-check-label" for="not_illust">この画像はイラストではありません</label>
      </div>
      <div class="form-check form-check-inline" v-else>
        <input class="form-check-input" type="radio" v-model="report_type" id="is_illust" value="is_illust">
        <label class="form-check-label" for="is_illust">この画像はイラストです</label>
      </div>
      <div class="form-check form-check-inline" v-if="is_nsfw">
        <input class="form-check-input" type="radio" v-model="report_type" id="radio_safe" value="safe">
        <label class="form-check-label" for="radio_safe">この画像はNSFWではありません</label>
      </div>
      <div class="form-check form-check-inline" v-else>
        <input class="form-check-input" type="radio" v-model="report_type" id="radio_nsfw" value="not_safe">
        <label class="form-check-label" for="radio_nsfw">この画像はNSFWです</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" v-model="report_type" id="radio_deleted" value="deleted">
        <label class="form-check-label" for="radio_deleted">この画像は削除されました</label>
      </div>
    </div>
    <button type="submit" id="report" class="btn btn-danger">報告する</button>
  </form>
  <hr>
  <h2 class="h5 mt-5">出典ツイート</h2>
    <blockquote class="twitter-tweet tw-align-center" data-conversation="none"><a href="https://twitter.com/user/status/{{ status_id }}"></a></blockquote>
  <h2 class="h5 mt-5">類似イラスト</h2>
  <div class="row">
    <div class="col-4 col-md-3 col-lg-2 my-1 px-1" v-for="sim in similar_images">
      <a v-bind:href="sim.status_url"><img class="img-fluid" v-bind:src="sim.media_url"></a></div>
  </div>
</div>
{% endif %}
{% endblock %}

{% block script %}
{% if registered %}
<script src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<script src="https://unpkg.com/vue@3.2.26"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
const app = Vue.createApp({
  data() {
    return { 
      success: true,
      image_number: {{ number }},
      rating: "",
      i2vtags: [],
      characters: [],
      candidates: [],
      media_url: "",
      image_data: [],
      character_name: "",
      similar_images: [],
      similar_characters: [],
      name_candidates: [],
      is_nsfw: undefined,
      collection: undefined,
      confirmed: undefined,
      report_type: "not_illust",
    }
  },
  mounted() {
    axios.get('{% url 'get_images' status_id %}')
      .then(res => {
        this.success = res.data.success;
        if(this.success) {
          var n = this.image_number;
          this.image_data = res.data.image_data;
          this.characters = this.image_data[n].characters;
          this.candidates = this.image_data[n].candidates;
          this.i2vtags = this.image_data[n].i2vtags;
          this.rating = this.image_data[n].rating;
          this.media_url = this.image_data[n].media_url;
          this.is_nsfw = this.image_data[n].is_nsfw;
          this.collection = this.image_data[n].collection;
          this.confirmed = this.image_data[n].confirmed;
          axios.post('{% url 'get_similar_images' %}', {
              media_url: this.media_url,
          }).then(res => {
            if(res.data.success) {
              this.similar_images = res.data.similar_images;
              this.similar_characters = res.data.similar_characters;
            }
          });
        }
      });
    const url = new URL(window.location);
    url.searchParams.set('n', this.image_number);
    history.replaceState({}, '', url);
  },
  methods: {
    updateImage: function(n) {
      this.image_number = n;
      this.i2vtags = this.image_data[n].i2vtags;
      this.rating = this.image_data[n].rating;
      this.media_url = this.image_data[n].media_url;
      this.collection = this.image_data[n].collection;
      this.confirmed = this.image_data[n].confirmed;
      const url = new URL(window.location);
      url.searchParams.set('n', this.image_number);
      history.replaceState({}, '', url);
    },
    registerName: function(name) {
      axios.post('{% url 'register_character' %}', {
          status_id: "{{ status_id }}",
          image_number: this.image_number,
          name_en: name
      }).then(res => {
      if (res.data.success) {
            alert("キャラクター名が登録されました（"+name+"）");
            var character = {name_en: name, name_ja: ""};
            this.characters.push(character);
            this.confirmed = true;
      } else {
            alert("キャラクター名の登録に失敗しました（"+name+"）");
      }
      });
    },
    submitInfo: function() {
      var name = this.$refs.input.value;
      this.registerName(name);
    },
    deleteName: function(name) {
      axios.post('{% url 'delete_character' %}', {
          status_id: "{{ status_id }}",
          image_number: this.image_number,
          name: name
      }).then(res => {
      if (res.data.success) {
            alert("キャラクター名を削除しました（"+name+"）");
            this.characters = this.characters.filter(item => item.name_en != name);
      } else {
            alert("キャラクター名の削除に失敗しました（"+name+"）");
      }
      });
    },
    formSubmit: function(e) {
        e.preventDefault();
        axios.post('{% url 'report' %}', {
            status_id: "{{ status_id }}",
        image_number: this.image_number,
        report_type: this.report_type,
        }).then(res => {
          if(res.data.success) {
            alert("報告が完了しました");
            if(this.report_type == "safe") {
                this.is_nsfw = false;
            } else if (this.report_type == "not_safe") {
                this.is_nsfw = true;
            } else if (this.report_type == "is_illust") {
              this.collection = true;
            } else if (this.report_type == "not_illust") {
              this.collection = false;
            } else if (this.report_type == "deleted") {
              this.collection = false;
            }
          } else {
            alert("報告に失敗しました");
      }
        });
    },
    suggest_character: function(e) {
      var content = this.$refs.input.value;
      if (content.length < 3) {
        this.name_candidates = [];
        return;
      }
      axios.post('{% url 'suggest_character' %}', {
          content: content
      }).then(res => {
          if(res.data.success) {
            this.name_candidates = res.data.names;
          }
      });
    },
  },
  compilerOptions: {
    delimiters: ["[[", "]]"]
  }
});

const vm = app.mount('#app');

</script>
{% else %}
<script>
setTimeout(function () { location.reload(); }, 3000);
</script>
{% endif %}  
{% endblock %}
